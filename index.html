<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>How OG are you (Stacks) ‚Äî OG Card</title>
<meta name="description" content="Check your Stacks OG card: transactions, first tx date, join position, export image." />
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  /* ...all your existing CSS unchanged... */
</style>
</head>
<body>
<main>
  <div class="hero">
    <div class="title">How OG are you on Stacks?</div>
    <div class="subtitle">Paste your address (no wallet connection required) ‚Äî results are read-only.</div>
  </div>
  <div class="controls" role="search" aria-label="Address input">
    <input id="addrInput" placeholder="Enter your STX address ‚Äî e.g. SP..." aria-label="Stacks address" />
    <button id="checkBtn" class="btn-check" aria-controls="resultCard">CHECK</button>
  </div>
  <div id="errorMsg" class="muted" role="status" aria-live="polite" style="height:18px;"></div>
  <div id="resultCard" class="card hidden" aria-live="polite" style="position:relative;">
    <div id="overlay" class="overlay" style="display:none;">
      <div style="text-align:center;">
        <div class="spinner" role="status" aria-label="Loading"></div>
        <div style="height:8px"></div>
        <div class="muted">Fetching chain data‚Ä¶</div>
      </div>
    </div>
    <div class="card-head">
      <div>
        <div class="card-title">My OG Card</div>
        <div class="muted" style="font-size:0.82rem; margin-top:2px;">https://stacks-og.vercel.app/</div>
      </div>
      <div class="avatar bounce" id="avatar" title="OG avatar" aria-hidden="true">üê±</div>
    </div>
    <div style="margin-top:10px;">
      <div id="txCount" class="tx-count">-- Transactions</div>
      <div id="firstTx" class="first-tx">First tx: --</div>
      <div class="timeline-wrap">
        <div class="timeline" id="timeline">
          <div class="timeline-progress" id="timelineProgress"></div>
          <div class="dot" style="left:0%;"></div>
          <div class="you-dot" id="youDot" style="left:12%;"></div>
          <div class="dot" style="left:100%; transform:translateX(-100%);"></div>
        </div>
        <div class="timeline-labels">
          <div>Launch</div>
          <div class="muted">You</div>
          <div>Now</div>
        </div>
      </div>
      <div class="ranking">
        <div class="rank-big" id="rankBig">‚Äî</div>
        <div class="rank-sub" id="rankSub">out of ‚Äî users</div>
        <div class="muted" id="beforeAfter" style="font-size:0.9rem;"></div>
        <div class="muted" id="avatarLabel" style="font-size:0.92rem; margin-top:10px;"></div>
      </div>
      <div class="export-wrap">
        <button id="exportBtn" class="btn-export">‚¨Ü Export Image</button>
        <button id="retryBtn" class="muted-btn" style="display:none;">Try another</button>
      </div>
    </div>
  </div>
  <div style="height:22px;"></div>
  <div class="muted" style="font-size:0.84rem; text-align:center;">Results are read-only ‚Äî we never request wallet access. Data from Hiro Stacks API.</div>
  <div id="srAlert" role="status" aria-live="polite" style="position:absolute; left:-9999px; height:1px; width:1px; overflow:hidden"></div>
  <div id="toast" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
 background:#222; color:#fff; padding:10px 16px; border-radius:10px;
 font-size:0.9rem; opacity:0; pointer-events:none; transition:opacity 0.4s ease;">
</div>
</main>
<script>
const API_BASE = 'https://api.hiro.so/extended/v1/address/';
const LAUNCH_DATE = new Date('2021-01-14T00:00:00Z');

let totalUsers = 2000; // baseline
const addrInput = document.getElementById('addrInput');
const checkBtn = document.getElementById('checkBtn');
const resultCard = document.getElementById('resultCard');
const overlay = document.getElementById('overlay');
const errorMsg = document.getElementById('errorMsg');
const txCountEl = document.getElementById('txCount');
const firstTxEl = document.getElementById('firstTx');
const youDot = document.getElementById('youDot');
const timelineProgress = document.getElementById('timelineProgress');
const rankBig = document.getElementById('rankBig');
const rankSub = document.getElementById('rankSub');
const beforeAfter = document.getElementById('beforeAfter');
const exportBtn = document.getElementById('exportBtn');
const retryBtn = document.getElementById('retryBtn');

function isProbablyStacks(addr){
  if(!addr) return false;
  return /^S[PT][0-9a-zA-Z]{10,40}$/.test(addr);
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function fmtDateISO(iso){
  try{ return new Date(iso).toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});}catch(e){ return iso; }
}
function extractTimestamp(tx){
  if(!tx) return null;
  if(tx.parent_burn_header && tx.parent_burn_header.timestamp_iso) return tx.parent_burn_header.timestamp_iso;
  if(tx.burn_block_time_iso) return tx.burn_block_time_iso;
  if(tx.receipt_time_iso) return tx.receipt_time_iso;
  if(tx.burn_block_time) return new Date(tx.burn_block_time * 1000).toISOString();
  return null;
}
async function fetchGlobalTxRange() {
  const firstUrl = 'https://api.hiro.so/extended/v1/tx?limit=1&order_by=block_height.asc';
  const latestUrl = 'https://api.hiro.so/extended/v1/tx?limit=1&order_by=block_height.desc';
  const [firstRes, latestRes] = await Promise.all([fetch(firstUrl), fetch(latestUrl)]);
  if (!firstRes.ok || !latestRes.ok) throw new Error('Failed to fetch global chain range.');
  const firstData = await firstRes.json();
  const latestData = await latestRes.json();
  return {
    launchISO: extractTimestamp(firstData.results[0]),
    nowISO: extractTimestamp(latestData.results[0]),
  };
}
async function fetchTxMetaAndFirst(address){
  const metaUrl = `${API_BASE}${encodeURIComponent(address)}/transactions?limit=1`;
  const metaResp = await fetch(metaUrl);
  if(!metaResp.ok) throw new Error('Failed to fetch transactions (meta).');
  const meta = await metaResp.json();
  const total = meta.total || 0;
  if(total === 0) return { total:0, firstTxISO: null };
  const offset = Math.max(0, total - 1);
  const earliestUrl = `${API_BASE}${encodeURIComponent(address)}/transactions?limit=1&offset=${offset}`;
  const earliestResp = await fetch(earliestUrl);
  if(!earliestResp.ok) throw new Error('Failed to fetch earliest transaction.');
  const earliest = await earliestResp.json();
  const txObj = (earliest.results && earliest.results[0]) || null;
  const firstTxISO = extractTimestamp(txObj);
  return { total, firstTxISO };
}
function animateCount(el, from, to, ms=900){
  const start = performance.now();
  function step(now){
    const t = clamp((now - start)/ms, 0,1);
    const val = Math.round(from + (to - from) * (1 - Math.pow(1 - t, 2)));
    el.textContent = `${val} Transactions`;
    if(t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function computeScore(txCount){
  if(txCount >= 500) return 100;
  if(txCount >= 200) return 80;
  if(txCount >= 50) return 50;
  if(txCount >= 10) return 20;
  return 5;
}
function selectAvatar(score){
  if(score >= 100) return { emoji: "ü¶Å", label: "Apex OG ‚Äî top of the chain!" };
  if(score >= 80)  return { emoji: "üêØ", label: "Elite OG ‚Äî fierce and early." };
  if(score >= 50)  return { emoji: "üê±", label: "Solid OG ‚Äî steady and loyal." };
  if(score >= 20)  return { emoji: "üò∫", label: "Starter ‚Äî finding your paws." };
  return { emoji: "üêæ", label: "Newbie ‚Äî just starting the journey." };
}
function renderCard({total, firstTxISO}){
  resultCard.classList.remove('hidden');
  resultCard.classList.add('show');
  animateCount(txCountEl, 0, total, 900);
  const firstStr = firstTxISO ? fmtDateISO(firstTxISO) : 'N/A';
  firstTxEl.textContent = `First tx: ${firstStr}`;

  const launchTime = new Date(window.globalLaunchISO).getTime();
  const nowTime = new Date(window.globalNowISO).getTime();
  let posNormalized = 0.5;
  if (firstTxISO) {
    const userFirstTime = new Date(firstTxISO).getTime();
    posNormalized = clamp((userFirstTime - launchTime) / (nowTime - launchTime), 0, 1);
  } else posNormalized = 1;

  const pct = posNormalized * 100;
  youDot.style.left = '0%';
  timelineProgress.style.width = '0%';
  setTimeout(() => {
    youDot.style.left = pct + '%';
    timelineProgress.style.width = '100%';
  }, 50);

  totalUsers += 1;

  const rank = Math.max(1, Math.min(totalUsers, Math.round(posNormalized * (totalUsers - 1)) + 1));
  const before = rank - 1;
  const after = totalUsers - rank;
  function ordinal(n){
    const s = ["th","st","nd","rd"], v = n % 100;
    return n + (s[(v-20)%10] || s[v] || s[0]);
  }
  rankBig.textContent = ordinal(rank);
  rankSub.textContent = `out of ${totalUsers} users`;
  beforeAfter.textContent = `${before} before ¬∑ ${after} after`;

  const score = computeScore(total);
  const avatarData = selectAvatar(score);
  const avatar = document.getElementById('avatar');
  const avatarLabel = document.getElementById('avatarLabel');
  avatar.textContent = avatarData.emoji;
  avatarLabel.textContent = avatarData.label;
  avatar.style.boxShadow = score >= 80
    ? '0 10px 36px rgba(0,212,255,0.18)'
    : '0 6px 18px rgba(0,255,130,0.06)';

  retryBtn.style.display = 'inline-block';
}
function setLoading(on){
  overlay.style.display = on ? 'flex' : 'none';
  checkBtn.disabled = on;
  addrInput.disabled = on;
}
function setError(msg){ errorMsg.textContent = msg || ''; }

checkBtn.addEventListener('click', async () => {
  const addr = addrInput.value.trim();
  setError('');
  if(!isProbablyStacks(addr)){
    setError('Enter a valid STX address (starts with SP or ST).');
    return;
  }
  resultCard.classList.remove('show');
  resultCard.classList.add('hidden');
  setLoading(true);
  try {
    const globalRange = await fetchGlobalTxRange();
    window.globalLaunchISO = globalRange.launchISO;
    window.globalNowISO = globalRange.nowISO;
    const meta = await fetchTxMetaAndFirst(addr);
    renderCard(meta);
  } catch (err) {
    console.error(err);
    setError('Unable to fetch data. Try again later or check the address.');
  } finally {
    setLoading(false);
  }
});
retryBtn.addEventListener('click', () => {
  resultCard.classList.remove('show');
  resultCard.classList.add('hidden');
  retryBtn.style.display = 'none';
  addrInput.focus();
});
function showToast(message, type = "info", duration = 2500) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  if (type === "success") toast.style.background = "rgba(0, 180, 80, 0.9)";
  else if (type === "error") toast.style.background = "rgba(200, 40, 40, 0.9)";
  else toast.style.background = "rgba(34,34,34,0.9)";
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, duration);
}
exportBtn.addEventListener('click', async () => {
  exportBtn.disabled = true;
  exportBtn.textContent = 'Preparing‚Ä¶';
  try {
    const bodyBg = getComputedStyle(document.body).backgroundImage;
    const originalBg = resultCard.style.background;
    resultCard.style.background = bodyBg;

    const canvas = await html2canvas(resultCard, { scale: window.devicePixelRatio || 2 });
    const link = document.createElement('a');
    link.download = `og-card-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    resultCard.style.background = originalBg;
    document.getElementById('srAlert').textContent = "Export complete. Image downloaded.";
    showToast("‚úÖ Export complete ‚Äî image downloaded.", "success");
  } catch (e) {
    console.error(e);
    setError('Export failed. Try again.');
    document.getElementById('srAlert').textContent = "Export failed.";
    showToast("‚ùå Export failed. Try again.");
  } finally {
    exportBtn.disabled = false;
    exportBtn.textContent = '‚¨Ü Export Image';
  }
});
addrInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') checkBtn.click(); });
addrInput.placeholder = 'e.g. SP2J... (paste a Stacks address)';
</script>
</body>
</html>
